(function ($) {

    $(document).ready(function () {  

        let preloader = `<svg  xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid" style="shape-rendering: auto; display: block; background: transparent;" width="20" height="20" xmlns:xlink="http://www.w3.org/1999/xlink"><g><circle stroke-dasharray="164.93361431346415 56.97787143782138" r="35" stroke-width="9" stroke="#ffffff" fill="none" cy="50" cx="50">
                        <animateTransform keyTimes="0;1" values="0 50 50;360 50 50" dur="1s" repeatCount="indefinite" type="rotate" attributeName="transform"></animateTransform>
                    </circle><g></g></g><!-- [ldio] generated by https://loading.io --></svg>`;

        //  close popup
        $('.wtd-promocart-popup-inner .close').click(function () {  
            $('.wtd-promocart-popup').removeClass('show');
        }); 

        // click apply button
        $(document).on('click', '.wtd-apply-cuppon', function () {  
            // add data nonce and action there has no from data
            var data = {
                nonce: wtd_promocart_popup_script.nonce, 
                action: 'wtd_promocart_apply_coupon', 
            };
            // add preloader before submit
            $('.wtd-apply-cuppon').append(preloader);
            // disable button
            $(this).prop('disabled', true);
            // add class disabled to prevent multiple submits
            $('.wtd-promocart-popup-inner .wtd-apply-cuppon').addClass('disabled');


            $.ajax({
                url: wtd_promocart_popup_script.ajaxurl, 
                type: 'POST',
                data: data, 
                success: function (response) {
                    if(response.success){  
                        // remove preloader
                        $('.wtd-apply-cuppon').find('.wtd-apply-cuppon svg').remove();  
                        // add a link to checkout button 
                        $('.wtd-promocart-popup-inner .wtd-apply-cuppon').html(wtd_promocart_popup_script.coupon_applied);
                        if(response.url){

                            $('.wtd-promocart-popup-inner .wtd-promocart-popup-content').append('<a href="' + response.url + '"  class="wtd-checkout-button">' + wtd_promocart_popup_script.checkout_button_text + '</a>');
                        }
                    }else{   
                        // remove preloader
                        $('.wtd-apply-cuppon').find('.wtd-apply-cuppon svg').remove();  
                        // remove disabled class
                        $('.wtd-promocart-popup-inner .wtd-apply-cuppon').removeClass('disabled');
                        // remove disabled attribute
                        $(this).prop('disabled', false);
                        // add error message
                        alert(response.message);
                    }
                },
                error: function (error) {
                    console.log(error);
                }
            });

        }); 

        // function for check and show popup
        function showPopup() {
            
            // add data nonce and action there has no from data
            var data = {
                nonce: wtd_promocart_popup_script.nonce, 
                action: 'wtd_promocart_check_popup_status', 
            };


            $.ajax({
                url: wtd_promocart_popup_script.ajaxurl, 
                type: 'POST',
                data: data, 
                success: function (response) {
                    if(response.success == true){  
                        // set time out 2 seconds and show popup
                        setTimeout(function () { 
                            $('.wtd-promocart-popup').addClass('show'); 
                        }, 2000);

                    }else{  
                        // alert(response.message);
                    }
                },
                error: function (error) {
                    console.log(error);
                }
            });
        }

        // Show Popup  document ready
        showPopup();

        //  check for popup after product add to cart
        $(document).on('added_to_cart', function (event, fragments, cart_hash) {
            showPopup();
        }); 
 
	}) 

})(jQuery);

 