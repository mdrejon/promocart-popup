(function ($) {

    $(document).ready(function () { 
        
		
        let preloader = `<svg  xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid" style="shape-rendering: auto; display: block; background: transparent;" width="20" height="20" xmlns:xlink="http://www.w3.org/1999/xlink"><g><circle stroke-dasharray="164.93361431346415 56.97787143782138" r="35" stroke-width="9" stroke="#ffffff" fill="none" cy="50" cx="50">
                        <animateTransform keyTimes="0;1" values="0 50 50;360 50 50" dur="1s" repeatCount="indefinite" type="rotate" attributeName="transform"></animateTransform>
                    </circle><g></g></g><!-- [ldio] generated by https://loading.io --></svg>`;

        // Select #cart_type on change
        $('#cart_type').on('change', function () {
            let cartType = $(this).val(); 
            if('cart_total' == cartType) {
                $('.condition-wrap').addClass('active'); 
                $('.total-amount-wrap').addClass('active'); 
                $('.total-item-wrap').removeClass('active'); 
                $('.products-wrap').removeClass('active'); 

            }
            if('cart_total_items' == cartType) {
                $('.condition-wrap').addClass('active'); 
                $('.total-item-wrap').addClass('active');
                $('.total-amount-wrap').removeClass('active');  
                $('.products-wrap').removeClass('active'); 

            }
            if('specific_products' == cartType) { 
                $('.products-wrap').addClass('active'); 
                $('.condition-wrap').removeClass('active'); 
                $('.total-item-wrap').removeClass('active');
                $('.total-amount-wrap').removeClass('active');  

            }
            // if cart type is empty
            if(cartType == '') {
                $('.condition-wrap').removeClass('active'); 
                $('.total-item-wrap').removeClass('active');
                $('.total-amount-wrap').removeClass('active');  
                $('.products-wrap').removeClass('active'); 

            }
        });

        // Loade select 2
        $("#specific_products").select2({
            placeholder: "Select options",
            allowClear: true
        });
        

        $(document).on('submit', '#wtd-popup-settings-form', function (e) {  
            e.preventDefault();   
            $this = $(this);
            var data  = new FormData(this);  

            
            var enable_status = $this.find('#enable_status');
            var error = false;
            var errorData = {};
            var cart_type = $this.find('#cart_type').val();
            var enable_status = $this.find('#enable_status');
            // checkbox checkeked value  
            var condition = $this.find('#condition').val();
            var total_amount = $this.find('#total_amount').val();
            var total_items = $this.find('#total_items').val();
            var specific_products = $this.find('#specific_products').val();

            // first remove all error class and error message
            $this.find('.error-message').remove();
            $this.find('.notice').remove();
            $this.find('.error').removeClass('error'); 
            if(cart_type == ''){
                error = true;
                errorData['cart_type'] = wtd_promocart_popup_admin.trans_string['Please select cart type'];
            }
            if('cart_total' == cart_type || 'cart_total_items' == cart_type) {
                if(condition == ''){
                    error = true;
                    errorData['condition'] = wtd_promocart_popup_admin.trans_string['Please select condition'];
                }
            }
            if('cart_total' == cart_type ) {
                if(total_amount == ''){
                    error = true;
                    errorData['total_amount'] = wtd_promocart_popup_admin.trans_string['Please select total amount'];
                }
            }
            if('cart_total_items' == cart_type ) {
                if(total_items == ''){
                    error = true;
                    errorData['total_items'] = wtd_promocart_popup_admin.trans_string['Please select total items'];
                }
            }
            if('specific_products' == cart_type) {
                if(specific_products.length == 0){
                    error = true;
                    errorData['specific_products'] = wtd_promocart_popup_admin.trans_string['Please select specific products'];
                }
            } 
          
            if(!enable_status.is(':checked')){
                error = false;
            }
            
            if(error) {
                  // show error message  and add class every field using id
                $.each(errorData, function(id, error) {
                    var errorText = '<span id="' + id + '_error" class="error-message"> '+ error + '</span>';
                    if ($('#' + id).parent().find('.select2-selection').length) {
                        $('#' + id).parent().find('.select2-selection').addClass('error');
                    } else {
                        $('#' + id).addClass('error');
                    }
                    $('#'+id).parent().append(errorText);
                });
                
                // remove error class and error message after 3 seconds
                setTimeout(function() {
                    $.each(errorData, function(id, error) { 
                        if ($('#' + id).parent().find('.select2-selection').length) {
                            $('#' + id).parent().find('.select2-selection').removeClass('error');
                        } else {
                            $('#' + id).removeClass('error');
                        }
                        $('#'+id+'_error').text('');
                    });
                }, 3000);
                return false;
            }


            // remove html 
            $this.find('.wtd-promocart-settings-submit svg').remove();
            $this.find('.wtd-promocart-settings-submit').append(preloader);
             
            
            data.append('action', 'wtd_promocart_popup_save_settings');   
            $.ajax({
                url: wtd_promocart_popup_admin.ajaxurl, 
                type: 'POST',
                data: data,
                processData: false,
                contentType: false,
                success: function (response) {
                    if(response.success){  
                        let notice = '<div class="notice notice-success "><p>' + response.message + '</p></div>';
                        $this.find('.wtd-promocart-settings-submit svg').remove();
                        $this.find('.wtd-promocart-settings-submit').parent().append(notice); 
                        // after 2 seconds remove notice  
                        setTimeout(function() {
                            $this.find('.wtd-promocart-settings-submit').parent().find('.notice').remove(); 
                        }, 2000);

                    }else{   
                        let notice = '<div class="notice notice-error "><p>' + response.message + '</p></div>'; 
                        $this.find('.wtd-promocart-settings-submit svg').remove(); 
                        $this.find('.wtd-promocart-settings-submit').parent().append(notice); 
                        // after 2 seconds remove notice   
                    }
                },
                error: function (error) {
                    console.log(error);
                }
            });
        });
 
	}) 

})(jQuery);

 